generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id        String    @id @default(cuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  createdByUser User? @relation("TenantCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("TenantUpdatedBy", fields: [updatedBy], references: [id])
  accounts  Account[]
  users     User[]
  buckets   Bucket[]
  objects   FileObject[]
}

model Account {
  id                 String   @id @default(cuid())
  name               String
  tenantId           String
  awsAccessKeyId     String?
  awsSecretAccessKey String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String?
  updatedBy          String?
  createdByUser      User?    @relation("AccountCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?    @relation("AccountUpdatedBy", fields: [updatedBy], references: [id])
  tenant             Tenant   @relation(fields: [tenantId], references: [id])
  buckets            Bucket[]
}

model Bucket {
  id        String       @id @default(cuid())
  name      String
  region    String
  accountId String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  createdBy String?
  updatedBy String?
  createdByUser User?    @relation("BucketCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("BucketUpdatedBy", fields: [updatedBy], references: [id])
  account   Account      @relation(fields: [accountId], references: [id])
  tenantId  String
  tenant    Tenant       @relation(fields: [tenantId], references: [id])
  objects   FileObject[]
  versioning Boolean     @default(false)
  encryption Boolean     @default(false)
  tags       String[]
  quotaBytes BigInt      @default(107374182400) // 100GB
}

model FileObject {
  id        String       @id @default(cuid())
  name      String
  key       String
  isFolder  Boolean      @default(false)
  size      Int?
  mimeType  String?
  bucketId  String
  parentId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  createdBy String?
  updatedBy String?
  createdByUser User?    @relation("FileObjectCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("FileObjectUpdatedBy", fields: [updatedBy], references: [id])
  bucket    Bucket       @relation(fields: [bucketId], references: [id])
  tenantId  String
  tenant    Tenant       @relation(fields: [tenantId], references: [id])
  parent    FileObject?  @relation("ParentChild", fields: [parentId], references: [id])
  children  FileObject[] @relation("ParentChild")
  searchVector Unsupported("tsvector")?

  @@index([searchVector], type: Gin)
  @@index([bucketId, key])
  @@index([bucketId, name])
  @@index([tenantId])
}

model User {
  id        String           @id @default(cuid())
  email     String           @unique
  password  String
  name      String?
  role      Role             @default(TEAMMATE)
  tenantId  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  createdBy String?
  updatedBy String?
  auditLogs AuditLog[]
  policies  ResourcePolicy[]
  // Auditing relations for other models
  tenantsCreated Tenant[] @relation("TenantCreatedBy")
  tenantsUpdated Tenant[] @relation("TenantUpdatedBy")
  accountsCreated Account[] @relation("AccountCreatedBy")
  accountsUpdated Account[] @relation("AccountUpdatedBy")
  bucketsCreated Bucket[] @relation("BucketCreatedBy")
  bucketsUpdated Bucket[] @relation("BucketUpdatedBy")
  filesCreated FileObject[] @relation("FileObjectCreatedBy")
  filesUpdated FileObject[] @relation("FileObjectUpdatedBy")
  usersCreated User[] @relation("UserCreatedBy")
  usersUpdated User[] @relation("UserUpdatedBy")
  policiesCreated ResourcePolicy[] @relation("PolicyCreatedBy")
  policiesUpdated ResourcePolicy[] @relation("PolicyUpdatedBy")
  auditLogsCreated AuditLog[] @relation("AuditLogCreatedBy")
  auditLogsUpdated AuditLog[] @relation("AuditLogUpdatedBy")
  
  createdByUser User? @relation("UserCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("UserUpdatedBy", fields: [updatedBy], references: [id])
  tenant    Tenant?          @relation(fields: [tenantId], references: [id])
}

model ResourcePolicy {
  id           String   @id @default(cuid())
  userId       String
  resourceType String
  resourceId   String?
  actions      String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?
  updatedBy    String?
  createdByUser User?   @relation("PolicyCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?   @relation("PolicyUpdatedBy", fields: [updatedBy], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  details   String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
  createdByUser User? @relation("AuditLogCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("AuditLogUpdatedBy", fields: [updatedBy], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

enum Role {
  PLATFORM_ADMIN
  TENANT_ADMIN
  TEAMMATE
}
