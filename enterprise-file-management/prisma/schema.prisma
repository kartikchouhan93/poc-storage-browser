generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id            String       @id @default(cuid())
  name          String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdBy     String?
  updatedBy     String?
  createdByUser User?        @relation("TenantCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?        @relation("TenantUpdatedBy", fields: [updatedBy], references: [id])
  accounts      Account[]
  users         User[]
  buckets       Bucket[]
  objects       FileObject[]
  teams         Team[]
  shares        Share[]
}

model Account {
  id                 String   @id @default(cuid())
  name               String
  tenantId           String
  awsAccessKeyId     String?
  awsSecretAccessKey String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String?
  updatedBy          String?
  createdByUser      User?    @relation("AccountCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?    @relation("AccountUpdatedBy", fields: [updatedBy], references: [id])
  tenant             Tenant   @relation(fields: [tenantId], references: [id])
  buckets            Bucket[]
}

model Bucket {
  id            String       @id @default(cuid())
  name          String
  region        String
  accountId     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdBy     String?
  updatedBy     String?
  createdByUser User?        @relation("BucketCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?        @relation("BucketUpdatedBy", fields: [updatedBy], references: [id])
  account       Account      @relation(fields: [accountId], references: [id])
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id])
  objects       FileObject[]
  versioning    Boolean      @default(false)
  encryption    Boolean      @default(false)
  tags          String[]
  quotaBytes    BigInt       @default(107374182400) // 100GB
  shares        Share[]
}

model FileObject {
  id            String                   @id @default(cuid())
  name          String
  key           String
  isFolder      Boolean                  @default(false)
  size          BigInt?
  mimeType      String?
  bucketId      String
  parentId      String?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  createdBy     String?
  updatedBy     String?
  createdByUser User?                    @relation("FileObjectCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?                    @relation("FileObjectUpdatedBy", fields: [updatedBy], references: [id])
  bucket        Bucket                   @relation(fields: [bucketId], references: [id])
  tenantId      String
  tenant        Tenant                   @relation(fields: [tenantId], references: [id])
  parent        FileObject?              @relation("ParentChild", fields: [parentId], references: [id])
  children      FileObject[]             @relation("ParentChild")
  shares        Share[]
  searchVector  Unsupported("tsvector")?

  @@index([searchVector], type: Gin)
  @@index([bucketId, key])
  @@index([bucketId, name])
  @@index([tenantId])
}

model User {
  id          String           @id @default(cuid())
  cognitoSub  String?          @unique
  email       String           @unique
  password    String?
  name        String?
  role        Role             @default(TEAMMATE)
  tenantId    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  hasLoggedIn Boolean          @default(false)
  auditLogs   AuditLog[]
  policies    ResourcePolicy[]
  tenant      Tenant?          @relation(fields: [tenantId], references: [id])
  teams       TeamMembership[]

  // Auditing back-references (required by named relations on other models)
  tenantsCreated   Tenant[]         @relation("TenantCreatedBy")
  tenantsUpdated   Tenant[]         @relation("TenantUpdatedBy")
  accountsCreated  Account[]        @relation("AccountCreatedBy")
  accountsUpdated  Account[]        @relation("AccountUpdatedBy")
  bucketsCreated   Bucket[]         @relation("BucketCreatedBy")
  bucketsUpdated   Bucket[]         @relation("BucketUpdatedBy")
  filesCreated     FileObject[]     @relation("FileObjectCreatedBy")
  filesUpdated     FileObject[]     @relation("FileObjectUpdatedBy")
  policiesCreated  ResourcePolicy[] @relation("PolicyCreatedBy")
  policiesUpdated  ResourcePolicy[] @relation("PolicyUpdatedBy")
  auditLogsCreated AuditLog[]       @relation("AuditLogCreatedBy")
  auditLogsUpdated AuditLog[]       @relation("AuditLogUpdatedBy")
  sharesCreated    Share[]          @relation("ShareCreatedBy")
  sharesUpdated    Share[]          @relation("ShareUpdatedBy")
}

model ResourcePolicy {
  id            String   @id @default(cuid())
  userId        String?
  teamId        String?
  resourceType  String
  resourceId    String?
  actions       String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?
  createdByUser User?    @relation("PolicyCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("PolicyUpdatedBy", fields: [updatedBy], references: [id])
  user          User?    @relation(fields: [userId], references: [id])
  team          Team?    @relation(fields: [teamId], references: [id])
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  action        String
  resource      String
  details       String?
  status        String
  ipAddress     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?
  createdByUser User?    @relation("AuditLogCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?    @relation("AuditLogUpdatedBy", fields: [updatedBy], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([userId, action])
}

enum Role {
  PLATFORM_ADMIN
  TENANT_ADMIN
  TEAM_ADMIN
  TEAMMATE
}

enum ShareStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

model Team {
  id         String           @id @default(cuid())
  name       String
  tenantId   String
  allowedIps String?
  tenant     Tenant           @relation(fields: [tenantId], references: [id])
  members    TeamMembership[]
  policies   ResourcePolicy[]
  isDeleted  Boolean          @default(false)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model TeamMembership {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  user      User     @relation(fields: [userId], references: [id])
  team      Team     @relation(fields: [teamId], references: [id])
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([userId, teamId])
}

model SyncHistory {
  id          String         @id @default(cuid())
  status      String // "SUCCESS", "FAILED", "IN_PROGRESS"
  startedAt   DateTime       @default(now())
  completedAt DateTime?
  totalFiles  Int            @default(0)
  syncedFiles Int            @default(0)
  failedFiles Int            @default(0)
  activities  SyncActivity[]
}

model SyncActivity {
  id        String      @id @default(cuid())
  historyId String
  action    String // "UPLOAD", "DOWNLOAD", "SKIP", "DELETE"
  fileName  String
  status    String // "SUCCESS", "FAILED"
  error     String?
  createdAt DateTime    @default(now())
  history   SyncHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)
}

model Share {
  id                String      @id @default(cuid())
  fileId            String
  tenantId          String
  bucketId          String
  toEmail           String
  expiry            DateTime
  downloadLimit     Int         @default(3)
  downloads         Int         @default(0)
  passwordProtected Boolean     @default(false)
  passwordHash      String?
  status            ShareStatus @default(ACTIVE)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  createdBy         String?
  updatedBy         String?
  createdByUser     User?       @relation("ShareCreatedBy", fields: [createdBy], references: [id])
  updatedByUser     User?       @relation("ShareUpdatedBy", fields: [updatedBy], references: [id])
  file              FileObject  @relation(fields: [fileId], references: [id])
  tenant            Tenant      @relation(fields: [tenantId], references: [id])
  bucket            Bucket      @relation(fields: [bucketId], references: [id])

  @@index([fileId])
  @@index([tenantId])
  @@index([bucketId])
  @@index([toEmail])
  @@index([status])
}
